# Chapter 8: è§†å›¾å®šä½å™¨

åœ¨[ç¬¬ä¸ƒç« ï¼šé¡µé¢è§†å›¾æ¨¡å‹åŸºç±»](07_é¡µé¢è§†å›¾æ¨¡å‹åŸºç±»_.md)ä¸­ï¼Œæˆ‘ä»¬ä¸ºæ‰€æœ‰ViewModelå»ºç«‹äº†æ ‡å‡†åŒ–çš„åŸºç¡€èƒ½åŠ›ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ™ºèƒ½çš„"çº¢å¨˜"â€”â€”**è§†å›¾å®šä½å™¨**ï¼Œå®ƒèƒ½è‡ªåŠ¨ä¸ºViewModelæ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„Viewï¼Œå°±åƒæœˆè€ç‰µçº¢çº¿ä¸€æ ·å·§å¦™ï¼

## ä¸ºä»€ä¹ˆéœ€è¦è§†å›¾å®šä½å™¨ï¼Ÿ

æƒ³è±¡ä½ å»å‚åŠ ç›¸äº²å¤§ä¼šğŸ’‘ï¼š
- **æ‰‹åŠ¨é…å¯¹**ï¼šéœ€è¦è®°ä½æ¯ä¸ªå˜‰å®¾çš„ç¼–å·ï¼Œæ‰‹åŠ¨åŒ¹é…åŒæ–¹ä¿¡æ¯
- **æ™ºèƒ½åŒ¹é…ç³»ç»Ÿ**ï¼šè¾“å…¥å§“ååè‡ªåŠ¨æ˜¾ç¤ºåˆé€‚å¯¹è±¡çš„æ‰€æœ‰èµ„æ–™

è§†å›¾å®šä½å™¨å°±æ˜¯è¿™æ ·çš„æ™ºèƒ½ç³»ç»Ÿï¼Œå®ƒè§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š
1. ğŸ”— è‡ªåŠ¨å…³è”Viewä¸ViewModel
2. ğŸ§© å‡å°‘æ‰‹åŠ¨ç»‘å®šçš„é‡å¤ä»£ç 
3. ğŸš€ å®ç°çœŸæ­£çš„MVVMåˆ†ç¦»

## æœ€ç®€å•çš„åŒ¹é…è§„åˆ™

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒViewå’ŒViewModeléµå¾ªå‘½åçº¦å®šï¼š
- ViewModelåç§°ï¼š`MainWindowViewModel`
- å¯¹åº”Viewåç§°ï¼š`MainWindowView`

å°±åƒæƒ…ä¾£è£…ğŸ‘«ï¼Œé€šè¿‡ç›¸åŒçš„å‰ç¼€å°±èƒ½è¯†åˆ«é…å¯¹å…³ç³»ã€‚

## æ ¸å¿ƒå·¥ä½œåŸç†

è§†å›¾å®šä½å™¨ç»§æ‰¿è‡ª`IDataTemplate`æ¥å£ï¼Œè¿™æ˜¯Avaloniaçš„æ•°æ®æ¨¡æ¿ç³»ç»Ÿï¼š

```mermaid
sequenceDiagram
    participant ç³»ç»Ÿ as Avaloniaç³»ç»Ÿ
    participant å®šä½å™¨ as è§†å›¾å®šä½å™¨
    participant DI as æœåŠ¡å®¹å™¨
    
    ç³»ç»Ÿ->>å®šä½å™¨: éœ€è¦æ˜¾ç¤ºæŸä¸ªViewModel
    å®šä½å™¨->>å®šä½å™¨: å°†"ViewModel"æ›¿æ¢ä¸º"View"
    å®šä½å™¨->>DI: å°è¯•è·å–Viewå®ä¾‹
    DI-->>å®šä½å™¨: è¿”å›å·²æ³¨å†Œçš„View
    å®šä½å™¨-->>ç³»ç»Ÿ: è¿”å›åŒ¹é…çš„Viewæ§ä»¶
```

## å®æˆ˜ä»£ç è§£æ

è§‚å¯Ÿé¡¹ç›®ä¸­çš„`ViewLocator.cs`å®ç°ï¼š

```csharp
public Control? Build(object? param)
{
    if (param is null) return null; // ç©ºå€¼æ£€æŸ¥
    
    // åƒç¿»è¯‘å®˜ä¸€æ ·è½¬æ¢åç§°
    var viewTypeName = param.GetType().FullName!
        .Replace("ViewModel", "View", StringComparison.Ordinal);
    
    // å°è¯•ä»DIå®¹å™¨è·å–è§†å›¾
    var view = Program.ServiceProvider?.GetService(viewType) as Control;
    if (view != null) return view; // å®¹å™¨ä¸­æœ‰å°±ç›´æ¥è¿”å›
    
    // å®¹å™¨ä¸­æ²¡æœ‰å°±æ–°å»ºå®ä¾‹
    return (Control)Activator.CreateInstance(viewType)!;
}
```

è¿™æ®µä»£ç å°±åƒæ™ºèƒ½å”®è´§æœºï¼š
1. æ¥æ”¶ViewModelç¡¬å¸ï¼ˆè¾“å…¥å‚æ•°ï¼‰
2. è‡ªåŠ¨æ¢ç®—æˆå¯¹åº”çš„Viewå•†å“åç§°
3. å…ˆæ£€æŸ¥VIPè´§æ¶ï¼ˆDIå®¹å™¨ï¼‰
4. æ²¡æœ‰å†åˆ°æ™®é€šè´§æ¶ï¼ˆåŠ¨æ€åˆ›å»ºï¼‰å–è´§

## è‡ªåŠ¨åŒ¹é…æœºåˆ¶

å…³é”®çš„`Match`æ–¹æ³•å†³å®šå“ªäº›å¯¹è±¡ä½¿ç”¨æ­¤å®šä½å™¨ï¼š

```csharp
public bool Match(object? data)
{
    return data is ViewModelBase; // åªè¦æ˜¯ViewModelBaseçš„å­ç±»å°±åŒ¹é…
}
```

è¿™ç›¸å½“äºç›¸äº²ä¼šçš„å…¥åœºè§„åˆ™ï¼š
- åªæœ‰æºå¸¦`ViewModelBase`èº«ä»½è¯çš„å˜‰å®¾æ‰èƒ½å‚ä¸åŒ¹é…

## ä¸¤ç§è¿è¡Œæ¨¡å¼å¯¹æ¯”

### 1. ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼ˆæ¨èï¼‰
```csharp
// ä¼˜å…ˆä»å®¹å™¨è·å–
var view = Program.ServiceProvider?.GetService(viewType) as Control;
```
ä¼˜ç‚¹ï¼š
- å¯åˆ©ç”¨DIç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ”¯æŒä¾èµ–æ³¨å…¥

### 2. åŠ¨æ€åˆ›å»ºæ¨¡å¼
```csharp
// ç›´æ¥å®ä¾‹åŒ–
return (Control)Activator.CreateInstance(viewType)!;
```
ä¼˜ç‚¹ï¼š
- æ›´è½»é‡
- ä¸éœ€è¦æå‰æ³¨å†Œ

## å¸¸è§é—®é¢˜è§£ç­”

â“ å¦‚ä½•è‡ªå®šä¹‰åŒ¹é…è§„åˆ™ï¼Ÿ
é‡å†™`Build`æ–¹æ³•ï¼Œä¿®æ”¹åç§°è½¬æ¢é€»è¾‘ï¼š
```csharp
var viewTypeName = param.GetType().FullName!
    .Replace("Model", "Page", StringComparison.Ordinal);
```

â“ Viewæ‰¾ä¸åˆ°æ€ä¹ˆåŠï¼Ÿ
å®šä½å™¨ä¼šè¿”å›æç¤ºæ–‡æœ¬ï¼š
```csharp
return new TextBlock { Text = "Not Found: " + viewTypeName };
```

## æ€»ç»“

æœ¬ç« æˆ‘ä»¬å­¦ä¼šäº†ï¼š
- è§†å›¾å®šä½å™¨çš„è‡ªåŠ¨åŒ¹é…åŸç†
- ä¸¤ç§è§†å›¾è§£ææ–¹å¼ï¼ˆDIä¼˜å…ˆï¼‰
- å¦‚ä½•é€šè¿‡å‘½åçº¦å®šå…³è”Viewå’ŒViewModel

å°±åƒä¸ºåº”ç”¨é…å¤‡äº†æ™ºèƒ½å©šä»‹ç³»ç»Ÿï¼Œè§†å›¾å®šä½å™¨è®©Viewå’ŒViewModelçš„é…å¯¹å˜å¾—è½»æ¾è‡ªç„¶ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„MVVMåº”ç”¨æ¡†æ¶ï¼

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)