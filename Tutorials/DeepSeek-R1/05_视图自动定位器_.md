

# Chapter 5: è§†å›¾è‡ªåŠ¨å®šä½å™¨

![æ™ºèƒ½é’¥åŒ™åŒ¹é…é”åŒ æ’ç”»](https://via.placeholder.com/800x400.png?text=è‡ªåŠ¨å®šä½å™¨ï¼šåƒé­”æ³•é’¥åŒ™è‡ªåŠ¨é€‚é…æ‰€æœ‰é”å­”)

åœ¨ä¸Šä¸€ç« [è§†å›¾æ¨¡å‹åŸºåº§](04_è§†å›¾æ¨¡å‹åŸºåº§_.md)ä¸­ï¼Œæˆ‘ä»¬ç»Ÿä¸€äº†ViewModelçš„æ¥å£ï¼ˆå°±åƒä¸ºæ‰€æœ‰ç”µå™¨è®¾è®¡æ ‡å‡†æ’åº§ï¼‰ã€‚ä½†å½“ç”¨æˆ·ç‚¹å‡»ã€Œæ‰“å¼€ç©ºè°ƒã€æŒ‰é’®æ—¶ï¼Œç•Œé¢å¦‚ä½•çŸ¥é“è¯¥æ˜¾ç¤ºå“ªä¸ªæ¸©åº¦æ§åˆ¶é¢æ¿ï¼ŸğŸ¤”

ã€Œè§†å›¾è‡ªåŠ¨å®šä½å™¨ã€å°±æ˜¯**èƒ½ç†è§£å‘½åè§„åˆ™çš„é­”æ³•è¿æ¥å™¨**ï¼Œè‡ªåŠ¨å°†ViewModelä¸å…¶å¯¹åº”çš„Viewé…å¯¹ï¼Œåƒæ™ºèƒ½é’¥åŒ™æ‰¾åˆ°æ­£ç¡®çš„é”å…·ä¸€æ ·ç¥å¥‡ï¼

---

## æ‰‹åŠ¨è¿æ¥çš„éº»çƒ¦

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¸©æ§ViewModelï¼š
```csharp
public class ThermoViewModel : ViewModelBase
{
    [ObservableProperty]
    private double _temperature = 26;
}
```

ä¼ ç»Ÿæ–¹å¼éœ€è¦æ‰‹åŠ¨åˆ›å»ºå¯¹åº”çš„Viewï¼š
```csharp
public class ThermoView : UserControl // æ¸©åº¦æ§åˆ¶ç•Œé¢
{
    public ThermoView()
    {
        // æ‰‹åŠ¨è®¾ç½®æ•°æ®ä¸Šä¸‹æ–‡ï¼ˆåƒç»™é’¥åŒ™è´´æ ‡ç­¾ï¼‰
        DataContext = new ThermoViewModel();
    }
}
```

è¿™ä¼šå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š
1. ğŸ”‘ æ¯æ–°å¢ä¸€ä¸ªåŠŸèƒ½æ¨¡å—éƒ½è¦æ‰‹åŠ¨ç¼–å†™è¿æ¥ä»£ç 
2. ğŸšª æ›´æ¢ViewModelæ—¶éœ€è¦åŒæ­¥ä¿®æ”¹æ‰€æœ‰å…³è”View

è§£å†³æ–¹æ³•â€”â€”**é€šè¿‡å‘½åçº¦å®šå®ç°è‡ªåŠ¨åŒ–åŒ¹é…**ï¼

---

## é­”æ³•é’¥åŒ™çš„ç”Ÿæˆæ³•åˆ™

### è§„åˆ™ä¸€ï¼šåç¼€æ›¿æ¢
ViewModelç±»å‹ååå¿…é¡»æœ‰ `ViewModel` åç¼€ï¼Œå¯¹åº”çš„Viewç±»å‹ååˆ™å°† `ViewModel` æ›¿æ¢ä¸º `View`ã€‚

ä»¥æ¸©åº¦æ§åˆ¶é¢æ¿ä¸ºä¾‹ï¼š
```
é’¥åŒ™æ¨¡æ¿ï¼š*ViewModel â†’ é”å…·æ¨¡æ¿ï¼š*View
ç¤ºä¾‹é’¥åŒ™ï¼šThermoViewModel â†’ å¯¹åº”é”å…·ï¼šThermoView
```

### è§„åˆ™äºŒï¼šå‘½åç©ºé—´æ˜ å°„
Viewå’ŒViewModelé€šå¸¸éœ€è¦åœ¨ç›¸åŒæˆ–å¯¹åº”çš„å‘½åç©ºé—´ä¸­ï¼š
```csharp
namespace SmartHome.ViewModels; // é’¥åŒ™ä»“åº“ï¼ˆViewModelå±‚ï¼‰
public class ThermoViewModel { ... }

namespace SmartHome.Views;      // é”å…·ä»“åº“ï¼ˆViewå±‚ï¼‰ 
public class ThermoView { ... }
```

---

## çœ‹çœ‹å®šä½å™¨çš„é­”æ³•ä»£ç 

æ‰“å¼€é¡¹ç›®ä¸­çš„ `ViewLocator.cs`ï¼š
```csharp
public class ViewLocator : IDataTemplate
{
    public Control? Build(object? param)
    {
        // æ­¥éª¤1ï¼šæ£€æŸ¥é’¥åŒ™å½¢çŠ¶ï¼ˆViewModelç±»å‹ï¼‰
        var viewModelType = param.GetType();
        
        // æ­¥éª¤2ï¼šç”Ÿæˆé”å…·åç§°ï¼ˆæ›¿æ¢åç¼€ï¼‰
        var viewTypeName = viewModelType.FullName!
            .Replace("ViewModel", "View", StringComparison.Ordinal);
        
        // æ­¥éª¤3ï¼šå¯»æ‰¾åŒ¹é…é”å…·ï¼ˆæŸ¥æ‰¾Viewç±»å‹ï¼‰
        var viewType = Type.GetType(viewTypeName);
        
        if (viewType != null)
        {
            // ä¼˜å…ˆä»æœåŠ¡å®¹å™¨è·å–ï¼ˆä½¿ç”¨é¢„åˆ¶é›¶ä»¶ï¼‰
            var view = Program.ServiceProvider?.GetService(viewType) as Control;
            if (view != null) return view;
            
            // æ‰¾ä¸åˆ°æ—¶è‡ªå·±é“¸é€ é’¥åŒ™ï¼ˆåˆ›å»ºå®ä¾‹ï¼‰
            return (Control)Activator.CreateInstance(viewType)!;
        }
        
        // æœªæ‰¾åˆ°æç¤ºï¼ˆä¸¢å¤±é’¥åŒ™çš„å‘Šè­¦æ ‡ç­¾ï¼‰
        return new TextBlock { Text = "Not Found: " + viewTypeName };
    }

    public bool Match(object? data) 
        => data is ViewModelBase; // åªå¤„ç†æ ‡å‡†é’¥åŒ™ç±»å‹
}
```

æ³¨é‡Šè§£æï¼š
- `Replace("ViewModel", "View")` â†’ æ–½å±•åç¼€æ›¿æ¢é­”æ³•
- `GetService(viewType)` â†’ ä¼˜å…ˆä½¿ç”¨ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­çš„é¢„æ³¨å†ŒView
- `Activator.CreateInstance` â†’ åº”æ€¥é“¸é€ æ–°å®ä¾‹çš„å®‰å…¨æªæ–½

---

## å®æˆ˜æ¼”ç»ƒï¼šè‡ªåŠ¨è¿æ¥ä¸‰éƒ¨æ›²

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ¸©æ§ç•Œé¢å¯¹
```csharp
// Viewå±‚ï¼ˆé”å…·ï¼‰
public class ThermoView : UserControl { ... }

// ViewModelå±‚ï¼ˆé’¥åŒ™ï¼‰
public class ThermoViewModel : ViewModelBase { ... }
```

### ç¬¬äºŒæ­¥ï¼šäº«ç”¨è‡ªåŠ¨åŒ¹é…
å½“å¯¼èˆªç³»ç»Ÿè¯·æ±‚æ˜¾ç¤º `ThermoViewModel` æ—¶ï¼š
```csharp
var thermoVM = new ThermoViewModel();
var thermoView = ViewLocator.Build(thermoVM); // é­”æ³•å¬å”¤Viewï¼
```

### ç¬¬ä¸‰æ­¥ï¼šç›´æ¥ä½¿ç”¨è§†å›¾ç»„ä»¶
```csharp
MainWindow.Content = thermoView; // å°†é¢æ¿åµŒå…¥ä¸»ç•Œé¢
```

æ•´ä¸ªè¿‡ç¨‹å°±åƒé­”æ³•å•†åº—è‡ªåŠ¨é€’é€åŒ¹é…çš„é­”æ–ä¸€æ ·ç¥å¥‡ï¼

---

## é­”æ³•åŸç†æµç¨‹å›¾è§£

```mermaid
sequenceDiagram
    participant VM as ThermoViewModel
    participant Locator as è§†å›¾å®šä½å™¨
    participant Service as æœåŠ¡ä¾›åº”å•†
    participant Viewer as ThermoView

    VM->>Locator: è¯·æ±‚è·å–åŒ¹é…çš„View
    Locator->>Locator: è½¬æ¢ThermoViewModel â†’ ThermoView
    Locator->>Service: æŸ¥è¯¢é¢„åˆ¶Viewç»„ä»¶
    alt æœåŠ¡ä¸­æœ‰åº“å­˜
        Service-->>Locator: è¿”å›ThermoView
    else æ— åº“å­˜
        Locator->>Viewer: åˆ›å»ºæ–°å®ä¾‹
    end
    Locator-->>VM: äº¤ä»˜å®Œæˆçš„Viewç»„ä»¶
```

å½“è¿è¡Œ `Build` æ–¹æ³•æ—¶ï¼š
1. ğŸ” å®šä½å™¨æ£€æŸ¥ViewModelçš„ç±»å‹åç§°
2. âœï¸ å°† `ViewModel` åç¼€æ›¿æ¢ä¸º `View`
3. ğŸ“¦ ä¼˜å…ˆä»æœåŠ¡å®¹å™¨è·å–å·²æ³¨å†Œçš„Viewå®ä¾‹
4. ğŸ› ï¸ æœªæ‰¾åˆ°æ—¶è‡ªåŠ¨åˆ›å»ºæ–°çš„Viewå®ä¾‹

---

## æ™ºèƒ½é™çº§æœºåˆ¶

è§‚å¯Ÿè¿™æ®µåº”æ€¥å¤„ç†ä»£ç ï¼š
```csharp
// ä¼˜å…ˆä½¿ç”¨å®¹å™¨ä¸­çš„å®ä¾‹ï¼ˆä¾èµ–æ³¨å…¥çš„ä¼˜åŠ¿ï¼‰
var view = Program.ServiceProvider?.GetService(viewType) as Control;

// é™çº§æ–¹æ¡ˆï¼šç›´æ¥åˆ›å»ºå®ä¾‹ï¼ˆå³ä½¿æœªæ³¨å†Œä¹Ÿèƒ½å·¥ä½œï¼‰
return (Control)Activator.CreateInstance(viewType)!;
```

è¿™å°±åƒï¼š
- é¦–é€‰å“ç‰Œé›¶ä»¶ï¼ˆæœåŠ¡å®¹å™¨é¢„æ³¨å†Œï¼‰
- è‹¥æ— åº“å­˜åˆ™ç°åœº3Dæ‰“å°ï¼ˆåŠ¨æ€åˆ›å»ºï¼‰

ä¿è¯ç³»ç»Ÿåœ¨æœªå®Œå…¨é…ç½®æ—¶ä¹Ÿèƒ½è¿è¡Œï¼

---

## æ€»ç»“ä¸é­”æ³•å‡çº§

æˆ‘ä»¬å·²ç»æŒæ¡ï¼š**è§†å›¾è‡ªåŠ¨å®šä½å™¨é€šè¿‡å‘½åçº¦å®šå’ŒåŠ¨æ€è§£æï¼Œå®ç°äº†ViewModelä¸Viewçš„è‡ªåŠ¨é…å¯¹**ã€‚è¿™ä¸ºåç»­çš„[ä¸»æ§ç•Œé¢ç®¡ç†å™¨](06_ä¸»æ§ç•Œé¢ç®¡ç†å™¨_.md)æä¾›äº†æ ¸å¿ƒå¯¼èˆªèƒ½åŠ›ã€‚

æœ¬ç« é‡ç‚¹ï¼š
1. ğŸ§™ é€šè¿‡åç¼€æ›¿æ¢å®ç°è‡ªåŠ¨ç±»å‹åŒ¹é…
2. ğŸ› ï¸ ç»“åˆä¾èµ–æ³¨å…¥ä¼˜å…ˆä½¿ç”¨é¢„åˆ¶ç»„ä»¶
3. âš ï¸ æ™ºèƒ½é™çº§æœºåˆ¶ä¿è¯ç³»ç»Ÿé²æ£’æ€§

ä¸‹ç« æˆ‘ä»¬å°†æ¢ç´¢[ä¸»æ§ç•Œé¢ç®¡ç†å™¨](06_ä¸»æ§ç•Œé¢ç®¡ç†å™¨_.md)ï¼Œå­¦ä¹ å¦‚ä½•é«˜æ•ˆè°ƒåº¦è¿™äº›è‡ªåŠ¨é…å¯¹çš„è§†å›¾ç»„ä»¶ï¼ğŸš€

> é­”å’’ç»ƒä¹ ï¼šåœ¨ä»£ç ä¸­æ·»åŠ ä¸€ä¸ª `LightControlViewModel`ï¼Œæµ‹è¯•æ˜¯å¦ä¼šè‡ªåŠ¨æ‰¾åˆ° `LightControlView`ï¼Ÿ

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)